<div class="form-container">
  <div class="form-header">
    <h1>{{ isEditMode ? 'Editar Producto' : 'Nuevo Producto' }}</h1>
  </div>

  <div *ngIf="loading && isEditMode" class="loading">
    <p>Cargando producto...</p>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="producto-form">
    <div class="form-grid">
      <!-- Nombre -->
      <div class="form-group full-width">
        <label for="nombre">Nombre del Producto *</label>
        <input
          id="nombre"
          type="text"
          formControlName="nombre"
          class="form-control"
          placeholder="Ej: Camiseta deportiva"
        >
        <div class="error-text" *ngIf="nombre?.invalid && nombre?.touched">
          <span *ngIf="nombre?.errors?.['required']">El nombre es requerido</span>
          <span *ngIf="nombre?.errors?.['minlength']">El nombre debe tener al menos 3 caracteres</span>
        </div>
      </div>

      <!-- Descripci√≥n -->
      <div class="form-group full-width">
        <label for="descripcion">Descripci√≥n *</label>
        <textarea
          id="descripcion"
          formControlName="descripcion"
          class="form-control"
          rows="4"
          placeholder="Describe tu producto..."
        ></textarea>
        <div class="error-text" *ngIf="descripcion?.invalid && descripcion?.touched">
          <span *ngIf="descripcion?.errors?.['required']">La descripci√≥n es requerida</span>
          <span *ngIf="descripcion?.errors?.['minlength']">La descripci√≥n debe tener al menos 10 caracteres</span>
        </div>
      </div>

      <!-- Precio -->
      <div class="form-group">
        <label for="precio">Precio *</label>
        <input
          id="precio"
          type="number"
          formControlName="precio"
          class="form-control"
          placeholder="0.00"
          step="0.01"
          min="0"
        >
        <div class="error-text" *ngIf="precio?.invalid && precio?.touched">
          <span *ngIf="precio?.errors?.['required']">El precio es requerido</span>
          <span *ngIf="precio?.errors?.['min']">El precio debe ser mayor a 0</span>
        </div>
      </div>

      <!-- Stock -->
      <div class="form-group">
        <label for="stock">Stock *</label>
        <input
          id="stock"
          type="number"
          formControlName="stock"
          class="form-control"
          placeholder="0"
          min="0"
        >
        <div class="error-text" *ngIf="stock?.invalid && stock?.touched">
          <span *ngIf="stock?.errors?.['required']">El stock es requerido</span>
          <span *ngIf="stock?.errors?.['min']">El stock no puede ser negativo</span>
        </div>
      </div>

      <!-- Categor√≠a -->
      <div class="form-group full-width">
        <label for="categoriaId">Categor√≠a *</label>
        <select
          id="categoriaId"
          formControlName="categoriaId"
          class="form-control"
        >
          <option [value]="null">Selecciona una categor√≠a</option>
          <option *ngFor="let categoria of categorias" [value]="categoria.id">
            {{ categoria.nombre }}
          </option>
        </select>
        <div class="error-text" *ngIf="categoriaId?.invalid && categoriaId?.touched">
          <span *ngIf="categoriaId?.errors?.['required']">La categor√≠a es requerida</span>
        </div>
      </div>

      <!-- Im√°genes del Producto (hasta 3) -->
      <div class="form-group full-width">
        <label>Im√°genes del Producto * <span class="hint">(hasta 3 im√°genes)</span></label>

        <!-- Toggle para seleccionar fuente de imagen -->
        <div class="image-source-toggle">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="imageSource === 'upload'"
            (click)="setImageSource('upload')"
          >
            <span class="icon">üìÅ</span>
            Subir archivo
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="imageSource === 'url'"
            (click)="setImageSource('url')"
          >
            <span class="icon">üîó</span>
            URL
          </button>
        </div>

        <!-- Grid de 3 im√°genes -->
        <div class="images-grid">
          <div *ngFor="let image of images; let i = index" class="image-slot">
            <div class="slot-label">Imagen {{ i + 1 }} {{ i === 0 ? '(Principal)' : '(Opcional)' }}</div>

            <!-- Si ya tiene imagen -->
            <div *ngIf="image.url" class="image-preview-slot">
              <img [src]="image.url" [alt]="'Imagen ' + (i + 1)">
              <button type="button" class="remove-image-btn" (click)="removeImage(i)" title="Eliminar imagen">
                ‚úï
              </button>
            </div>

            <!-- Si no tiene imagen - modo URL -->
            <div *ngIf="!image.url && imageSource === 'url'" class="url-input-slot">
              <input
                type="text"
                class="form-control"
                placeholder="https://ejemplo.com/imagen.jpg"
                [value]="image.url"
                (input)="onImageUrlChange(i, $event)"
              >
            </div>

            <!-- Si no tiene imagen - modo Upload -->
            <div
              *ngIf="!image.url && imageSource === 'upload'"
              class="upload-slot"
              [class.drag-over]="dragOverIndex === i"
              [class.uploading]="image.uploading"
              (dragover)="onDragOver($event, i)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event, i)"
            >
              <div *ngIf="!image.uploading" class="upload-content">
                <div class="upload-icon">üì∑</div>
                <p class="upload-text">Arrastra aqu√≠ o</p>
                <label class="upload-btn-small">
                  Seleccionar
                  <input
                    type="file"
                    accept="image/*"
                    (change)="onFileSelected($event, i)"
                    hidden
                  >
                </label>
              </div>
              <div *ngIf="image.uploading" class="upload-progress-slot">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="image.progress"></div>
                </div>
                <p>{{ image.progress }}%</p>
              </div>
            </div>
          </div>
        </div>

        <p class="images-hint">La primera imagen ser√° la imagen principal del producto. PNG, JPG, WEBP (m√°x. 5MB cada una)</p>
      </div>
    </div>

    <!-- Botones -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancelar()" [disabled]="loading">
        Cancelar
      </button>
      <button type="submit" class="btn-primary" [disabled]="loading || productoForm.invalid || !hasAtLeastOneImage()">
        {{ loading ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Crear Producto') }}
      </button>
    </div>
  </form>
</div>
