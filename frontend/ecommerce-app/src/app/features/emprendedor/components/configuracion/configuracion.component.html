<div class="configuracion-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Configuraci√≥n</h1>
    <p class="subtitle">Administra la configuraci√≥n de tu tienda y m√©todos de pago</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Cargando configuraci√≥n...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="config-wrapper">
    <!-- Tabs -->
    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'general'"
        (click)="setActiveTab('general')">
        <span class="tab-icon">‚öôÔ∏è</span>
        General
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'mercadopago'"
        (click)="setActiveTab('mercadopago')">
        <span class="tab-icon">üí≥</span>
        MercadoPago
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'suscripcion'"
        (click)="setActiveTab('suscripcion')">
        <span class="tab-icon">üìã</span>
        Suscripci√≥n
      </button>
    </div>

    <!-- Alerts -->
    <div *ngIf="successMessage" class="alert alert-success">
      ‚úì {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="alert alert-error">
      ‚úï {{ errorMessage }}
    </div>

    <!-- Tab Content: General -->
    <div *ngIf="activeTab === 'general'" class="tab-content">
      <div class="config-card">
        <h2>Configuraci√≥n General</h2>
        <p class="card-subtitle">Actualiza la informaci√≥n b√°sica de tu tienda</p>

        <form [formGroup]="tiendaForm" (ngSubmit)="saveGeneralConfig()">
          <div class="form-group">
            <label for="nombre">Nombre de la tienda *</label>
            <input
              type="text"
              id="nombre"
              formControlName="nombre"
              class="form-control"
              placeholder="Mi Tienda">
            <div class="error-message" *ngIf="tiendaForm.get('nombre')?.invalid && tiendaForm.get('nombre')?.touched">
              <span *ngIf="tiendaForm.get('nombre')?.errors?.['required']">El nombre es requerido</span>
              <span *ngIf="tiendaForm.get('nombre')?.errors?.['minlength']">M√≠nimo 3 caracteres</span>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripci√≥n</label>
            <textarea
              id="descripcion"
              formControlName="descripcion"
              class="form-control"
              rows="4"
              placeholder="Describe tu tienda..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="telefonoWhatsApp">Tel√©fono WhatsApp</label>
              <input
                type="text"
                id="telefonoWhatsApp"
                formControlName="telefonoWhatsApp"
                class="form-control"
                placeholder="+549123456789">
              <div class="error-message" *ngIf="tiendaForm.get('telefonoWhatsApp')?.invalid && tiendaForm.get('telefonoWhatsApp')?.touched">
                <span *ngIf="tiendaForm.get('telefonoWhatsApp')?.errors?.['pattern']">Formato inv√°lido (ej: +549123456789)</span>
              </div>
            </div>

            <div class="form-group">
              <label for="linkInstagram">Link de Instagram</label>
              <input
                type="text"
                id="linkInstagram"
                formControlName="linkInstagram"
                class="form-control"
                placeholder="https://instagram.com/tu-cuenta">
              <div class="error-message" *ngIf="tiendaForm.get('linkInstagram')?.invalid && tiendaForm.get('linkInstagram')?.touched">
                <span *ngIf="tiendaForm.get('linkInstagram')?.errors?.['pattern']">URL de Instagram inv√°lida</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="tiendaForm.invalid || saving">
              {{ saving ? 'Guardando...' : 'Guardar Cambios' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tab Content: MercadoPago -->
    <div *ngIf="activeTab === 'mercadopago'" class="tab-content">
      <div class="config-card">
        <h2>Configuraci√≥n de MercadoPago</h2>
        <p class="card-subtitle">Configura MercadoPago para recibir pagos en tu tienda</p>

        <!-- Estado de Conexi√≥n -->
        <div class="connection-status" [class.connected]="mercadoPagoConnected">
          <div class="status-indicator">
            <span class="status-dot" [class.active]="mercadoPagoConnected"></span>
            <span class="status-text">
              {{ mercadoPagoConnected ? 'Conectado' : 'No Conectado' }}
            </span>
          </div>
          <div *ngIf="mercadoPagoConnected && mercadoPagoPublicKey" class="status-details">
            <small>Public Key: {{ mercadoPagoPublicKey }}</small>
          </div>
        </div>

        <!-- Conexi√≥n OAuth (Recomendado) -->
        <div class="oauth-section" *ngIf="!mercadoPagoConnected || useManualCredentials">
          <div class="section-header-with-badge">
            <h3>Conexi√≥n R√°pida</h3>
            <span class="badge-recommended">Recomendado</span>
          </div>
          <p class="section-description">
            Conecta tu cuenta de MercadoPago con un solo clic. Es la forma m√°s f√°cil y segura de configurar los pagos.
          </p>

          <button
            class="btn-mercadopago"
            (click)="connectMercadoPago()"
            [disabled]="saving"
            *ngIf="!mercadoPagoConnected">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
              <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            Conectar con MercadoPago
          </button>

          <button
            class="btn-disconnect"
            (click)="disconnectMercadoPago()"
            [disabled]="saving"
            *ngIf="mercadoPagoConnected && !useManualCredentials">
            Desconectar MercadoPago
          </button>
        </div>

        <!-- Divisor -->
        <div class="section-divider-with-text" *ngIf="!mercadoPagoConnected">
          <span>O</span>
        </div>

        <!-- Credenciales Manuales (Avanzado) -->
        <div class="manual-section" *ngIf="!mercadoPagoConnected">
          <button
            class="btn-link"
            (click)="toggleManualCredentials()"
            type="button">
            {{ useManualCredentials ? 'Usar conexi√≥n r√°pida' : 'Configurar credenciales manualmente (Avanzado)' }}
          </button>

          <div class="manual-credentials" *ngIf="useManualCredentials">
            <div class="info-box">
              <div class="info-icon">‚ÑπÔ∏è</div>
              <div class="info-content">
                <h4>¬øC√≥mo obtengo mis credenciales?</h4>
                <ol>
                  <li>Ingresa a <a href="https://www.mercadopago.com.ar/developers/panel" target="_blank">MercadoPago Developers</a></li>
                  <li>Ve a la secci√≥n "Credenciales"</li>
                  <li>Copia tu Public Key y Access Token</li>
                  <li>Pega las credenciales en los campos de abajo</li>
                </ol>
              </div>
            </div>

            <form [formGroup]="mercadoPagoForm" (ngSubmit)="saveMercadoPagoConfig()">
              <div class="form-group">
                <label for="mercadoPagoPublicKey">Public Key</label>
                <input
                  type="text"
                  id="mercadoPagoPublicKey"
                  formControlName="mercadoPagoPublicKey"
                  class="form-control"
                  placeholder="APP_USR-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                <small class="form-hint">Esta clave se usa en el frontend para inicializar MercadoPago</small>
              </div>

              <div class="form-group">
                <label for="mercadoPagoAccessToken">Access Token</label>
                <input
                  type="password"
                  id="mercadoPagoAccessToken"
                  formControlName="mercadoPagoAccessToken"
                  class="form-control"
                  placeholder="APP_USR-xxxxxxxxxx-xxxxxx-xxxxxxxxxxxx">
                <small class="form-hint">Esta clave se usa en el backend para procesar pagos (mantener segura)</small>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary" [disabled]="saving">
                  {{ saving ? 'Guardando...' : 'Guardar Credenciales' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Content: Suscripci√≥n -->
    <div *ngIf="activeTab === 'suscripcion'" class="tab-content">
      <div class="config-card">
        <h2>Mi Suscripci√≥n</h2>
        <p class="card-subtitle">Administra tu plan y suscripci√≥n</p>

        <!-- Plan Actual -->
        <div class="plan-actual" *ngIf="tienda">
          <div class="plan-badge">Plan Actual</div>
          <h3>{{ tienda.planSuscripcion?.nombre || 'Sin Plan' }}</h3>
          <p class="plan-desc">{{ tienda.planSuscripcion?.descripcion || 'Sin l√≠mites para grandes emprendimientos' }}</p>

          <div class="plan-info-grid">
            <div class="info-item">
              <span class="label">Precio Mensual</span>
              <span class="value">${{ tienda.planSuscripcion?.precioMensual || 0 | number:'1.2-2' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Productos Permitidos</span>
              <span class="value">{{ tienda.planSuscripcion?.maxProductos || '‚àû' }}</span>
            </div>
            <div class="info-item" *ngIf="tienda.fechaVencimientoSuscripcion">
              <span class="label">Pr√≥xima Renovaci√≥n</span>
              <span class="value">{{ tienda.fechaVencimientoSuscripcion | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item">
              <span class="label">Estado</span>
              <span class="value status-active">Activa</span>
            </div>
          </div>
        </div>

        <!-- Cambiar Plan -->
        <div class="section-divider"></div>
        <div class="actions-section">
          <button class="btn-secondary" (click)="mostrarPlanes = !mostrarPlanes">
            {{ mostrarPlanes ? 'Cancelar' : 'Cambiar Plan' }}
          </button>
        </div>

        <!-- Planes Disponibles -->
        <div class="planes-container" *ngIf="mostrarPlanes">
          <h4>Selecciona un nuevo plan</h4>
          <div *ngIf="loadingPlanes" class="loading-small">
            <div class="spinner"></div>
            <p>Cargando planes...</p>
          </div>
          <div class="planes-grid" *ngIf="!loadingPlanes && planesDisponibles.length > 0">
            <div class="plan-card" *ngFor="let plan of planesDisponibles"
                 [class.current]="plan.id === tienda?.planSuscripcionId">
              <div class="plan-header">
                <h5>{{ plan.nombre }}</h5>
                <span class="badge-actual" *ngIf="plan.id === tienda?.planSuscripcionId">Actual</span>
              </div>
              <div class="plan-price">
                <span class="amount">${{ plan.precioMensual | number:'1.2-2' }}</span>
                <span class="period">/mes</span>
              </div>
              <p class="plan-description">{{ plan.descripcion }}</p>
              <ul class="plan-features">
                <li>Hasta {{ plan.maxProductos }} productos</li>
                <li>Panel de administraci√≥n</li>
                <li>Soporte t√©cnico</li>
              </ul>
              <button class="btn-primary"
                      (click)="cambiarPlan(plan)"
                      [disabled]="plan.id === tienda?.planSuscripcionId || saving">
                {{ plan.id === tienda?.planSuscripcionId ? 'Plan Actual' : 'Seleccionar' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Cancelar Suscripci√≥n -->
        <div class="section-divider"></div>
        <div class="danger-zone">
          <h4>Zona de Peligro</h4>
          <p>Si cancelas tu suscripci√≥n, perder√°s acceso a todas las funcionalidades de tu tienda.</p>
          <button class="btn-danger" (click)="cancelarSuscripcion()">
            Cancelar Suscripci√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
