<div class="container mt-4">
  <div class="mb-3">
    <a routerLink="/pedidos" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Volver a Mis Pedidos
    </a>
  </div>

  <div class="alert alert-success" *ngIf="mostrarMensajeExito">
    <i class="bi bi-check-circle-fill me-2"></i>
    <strong>¡Pedido realizado con éxito!</strong> Tu pedido ha sido procesado correctamente.
  </div>

  <div class="alert alert-success" *ngIf="mostrarMensajePagado">
    <i class="bi bi-credit-card-fill me-2"></i>
    <strong>¡Pago procesado exitosamente!</strong> Tu pago ha sido aprobado y el pedido está en espera de procesamiento.
  </div>

  <div class="text-center my-5" *ngIf="loading">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <div *ngIf="!loading && pedido">
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h4 class="mb-0">Pedido #{{ pedido.id }}</h4>
          </div>
          <div class="col-md-6 text-end">
            <span class="badge" [ngClass]="getEstadoClass(pedido.estado)">
              <i [class]="getEstadoIcono(pedido.estado)"></i>
              {{ pedido.estado }}
            </span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="text-muted">Información del Pedido</h6>
            <p class="mb-1">
              <strong>Fecha de Creación:</strong> {{ pedido.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
            </p>
            <p class="mb-1">
              <strong>Estado:</strong> {{ pedido.estado }}
            </p>
            <p class="mb-1" *ngIf="pedido.fechaPago">
              <strong>Fecha de Pago:</strong> {{ pedido.fechaPago | date:'dd/MM/yyyy HH:mm' }}
            </p>
            <p class="mb-1" *ngIf="pedido.metodoPago">
              <strong>Método de Pago:</strong> {{ pedido.metodoPago }}
            </p>
            <p class="mb-1" *ngIf="pedido.transaccionId">
              <strong>ID de Transacción:</strong> <span class="badge bg-info">{{ pedido.transaccionId }}</span>
            </p>
            <p class="mb-1" *ngIf="pedido.fechaDespacho">
              <strong>Fecha de Despacho:</strong> {{ pedido.fechaDespacho | date:'dd/MM/yyyy HH:mm' }}
            </p>
            <p class="mb-1" *ngIf="pedido.fechaEntrega">
              <strong>Fecha de Entrega:</strong> {{ pedido.fechaEntrega | date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Dirección de Envío</h6>
            <p class="mb-2">{{ pedido.direccionEnvio }}</p>

            <div *ngIf="pedido.numeroSeguimiento" class="alert alert-info mb-0">
              <h6 class="mb-2"><i class="bi bi-box-seam me-2"></i>Información de Envío</h6>
              <p class="mb-1">
                <strong>Servicio:</strong> {{ pedido.servicioEnvio }}
              </p>
              <p class="mb-1">
                <strong>Número de Seguimiento:</strong>
                <span class="badge bg-primary">{{ pedido.numeroSeguimiento }}</span>
              </p>
              <a [href]="getTrackingUrl(pedido.numeroSeguimiento)"
                 target="_blank"
                 class="btn btn-sm btn-outline-primary mt-2">
                <i class="bi bi-search me-1"></i>Ver Tracking
              </a>
            </div>
          </div>
        </div>

        <hr>

        <h5 class="mb-3">Productos</h5>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">Precio Unitario</th>
                <th class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of pedido.items">
                <td>
                  <div class="d-flex align-items-center">
                    <img
                      [src]="item.productoImagen || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23e9ecef%22 width=%2260%22 height=%2260%22/%3E%3Ctext fill=%22%236c757d%22 font-family=%22sans-serif%22 font-size=%2210%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EProducto%3C/text%3E%3C/svg%3E'"
                      [alt]="item.productoNombre || 'Producto'"
                      class="rounded me-3"
                      style="width: 60px; height: 60px; object-fit: cover;"
                    >
                    <div>
                      <strong>{{ item.productoNombre }}</strong>
                    </div>
                  </div>
                </td>
                <td class="text-center align-middle">
                  <span class="badge bg-secondary">{{ item.cantidad }}</span>
                </td>
                <td class="text-end align-middle">
                  ${{ item.precioUnitario | number:'1.2-2' }}
                </td>
                <td class="text-end align-middle">
                  <strong>${{ item.subtotal | number:'1.2-2' }}</strong>
                </td>
              </tr>
            </tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                <td class="text-end">
                  <strong class="h5 text-primary mb-0">${{ pedido.total | number:'1.2-2' }}</strong>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Timeline del estado del pedido -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Estado del Pedido</h5>
      </div>
      <div class="card-body">
        <div class="timeline">
          <!-- Mostrar "Pagado" solo si el estado es "Pagado", sino mostrar "Pendiente" -->
          <div class="timeline-item" [class.active]="pedido.estado === 'Pendiente' || pedido.estado === 'Pagado' || pedido.estado === 'Procesando' || pedido.estado === 'Enviado' || pedido.estado === 'Entregado'">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h6>{{ pedido.estado === 'Pagado' ? 'Pagado' : 'Pendiente' }}</h6>
              <p class="text-muted small">{{ pedido.estado === 'Pagado' ? 'Pedido recibido y pagado, en espera de procesamiento' : 'Pedido recibido y en espera de procesamiento' }}</p>
            </div>
          </div>
          <div class="timeline-item" [class.active]="pedido.estado === 'Procesando' || pedido.estado === 'Enviado' || pedido.estado === 'Entregado'">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h6>Procesando</h6>
              <p class="text-muted small">Preparando tu pedido para el envío</p>
            </div>
          </div>
          <div class="timeline-item" [class.active]="pedido.estado === 'Enviado' || pedido.estado === 'Entregado'">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h6>Enviado</h6>
              <p class="text-muted small">El pedido está en camino</p>
            </div>
          </div>
          <div class="timeline-item" [class.active]="pedido.estado === 'Entregado'">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h6>Entregado</h6>
              <p class="text-muted small">Pedido entregado exitosamente</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
